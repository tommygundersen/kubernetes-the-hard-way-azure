# Kubernetes the Hard Way - Azure Infrastructure with Terraform

This directory contains Terraform configuration files to provision the Azure infrastructure required for the "Kubernetes the Hard Way" lab. This provides a faster, parallel alternative to the bash scripts, especially useful for Windows users.

## 🏗️ Infrastructure Overview

The Terraform configuration creates:

- **Resource Group**: Container for all lab resources
- **Virtual Network**: 10.0.0.0/16 with three subnets
  - Azure Bastion subnet: 10.0.1.0/24 
  - Jumpbox subnet: 10.0.2.0/24
  - Kubernetes subnet: 10.0.3.0/24
- **NAT Gateway**: Provides internet access for private VMs
- **Azure Bastion**: Secure access to VMs (Developer Edition - Free)
- **Virtual Machines**:
  - 1x Jumpbox (10.0.2.10) with pre-installed tools
  - 1x Control Plane (10.0.3.10)
  - 2x Worker Nodes (10.0.3.20, 10.0.3.21)
- **Network Security Groups**: Properly configured for Kubernetes
- **Auto-shutdown**: Cost management feature

## 🚀 Quick Start

### Prerequisites

1. **Install Terraform**: Download from [terraform.io](https://www.terraform.io/downloads.html)
2. **Install Azure CLI**: [Azure CLI installation guide](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli)
3. **Azure Login**: `az login`

### Deployment Steps

1. **Clone the repository** (if not already done):
   ```bash
   git clone <repository-url>
   cd kubernetes-the-hard-way-azure/terraform
   ```

2. **Configure variables**:
   ```bash
   cp terraform.tfvars.example terraform.tfvars
   # Edit terraform.tfvars with your preferences
   ```

3. **Initialize Terraform**:
   ```bash
   terraform init
   ```

4. **Plan the deployment**:
   ```bash
   terraform plan
   ```

5. **Deploy the infrastructure**:
   ```bash
   terraform apply
   ```

6. **Note the outputs** - Terraform will display important connection information.

## ⚙️ Configuration Options

### terraform.tfvars

```hcl
# Azure region
location = "Sweden Central"

# VM configuration
vm_size = "Standard_B2s"  # Cost-effective for labs

# Student information (optional)
student_name = "student01"
environment  = "lab"

# Cost management
auto_shutdown_enabled  = true
auto_shutdown_time     = "1900"  # 7:00 PM
auto_shutdown_timezone = "UTC"

# SSH key (optional - will generate if not provided)
# ssh_public_key_path = "~/.ssh/id_rsa.pub"
```

### Available VM Sizes

| Size            | vCPUs | RAM  | Cost   | Use Case                 |
| --------------- | ----- | ---- | ------ | ------------------------ |
| Standard_B1s    | 1     | 1 GB | Lowest | Basic testing            |
| Standard_B2s    | 2     | 4 GB | Low    | **Recommended for labs** |
| Standard_B2ms   | 2     | 8 GB | Medium | Better performance       |
| Standard_D2s_v3 | 2     | 8 GB | Medium | Production-like          |

## 🔑 SSH Key Management

Terraform can either:
1. **Generate SSH keys automatically** (default)
2. **Use existing SSH keys** (set `ssh_public_key_path` in terraform.tfvars)

Generated keys are saved to `terraform/ssh-keys/`:
- Private key: `k8s-lab-key`
- Public key: `k8s-lab-key.pub`

## 🌐 Accessing Your Environment

### Option 1: Azure Bastion (Recommended)
1. Go to Azure Portal
2. Navigate to your jumpbox VM
3. Click "Connect" → "Bastion"
4. Use your admin username and SSH private key

### Option 2: Azure CLI (if you have local SSH)
```bash
# Copy the private key locally (if generated by Terraform)
az vm run-command invoke \
  --resource-group <resource-group-name> \
  --name <jumpbox-vm-name> \
  --command-id RunShellScript \
  --scripts "cat /home/azureuser/.ssh/authorized_keys"
```

## 📊 Cost Management

### Auto-Shutdown
- **Enabled by default**: VMs automatically shut down at 7:00 PM UTC
- **Customizable**: Modify `auto_shutdown_time` and `auto_shutdown_timezone`
- **Manual override**: Start VMs when needed via Azure Portal

### Cost Estimation
Approximate daily costs (West Europe):
- Standard_B2s VMs (4x): ~$8-12/day
- Storage and networking: ~$2-3/day
- **Total**: ~$10-15/day (with auto-shutdown)

## 🔧 Terraform Commands

### Essential Commands
```bash
# Initialize (first time only)
terraform init

# Plan changes
terraform plan

# Apply changes
terraform apply

# Show current state
terraform show

# List resources
terraform state list

# Get outputs
terraform output

# Destroy everything
terraform destroy
```

### Useful Terraform Commands
```bash
# Format code
terraform fmt

# Validate configuration
terraform validate

# Refresh state
terraform refresh

# Show specific output
terraform output vm_information
```

## 📋 Outputs

After deployment, Terraform provides:

- **Resource Group Name**: For Azure portal navigation
- **VM IP Addresses**: For SSH connections
- **SSH Key Locations**: If keys were generated
- **Connection Instructions**: Step-by-step access guide
- **Lab Configuration**: Kubernetes network settings
- **Next Steps**: What to do after infrastructure is ready

## 🐛 Troubleshooting

### Common Issues

1. **Authentication Error**:
   ```bash
   az login
   az account list  # Verify correct subscription
   ```

2. **Quota Exceeded**:
   - Try different Azure region
   - Use smaller VM sizes
   - Check Azure quotas in portal

3. **SSH Key Issues**:
   - Ensure proper permissions: `chmod 600 ssh-keys/k8s-lab-key`
   - Use full path to SSH key files

4. **VM Not Accessible**:
   - Check VM is running in Azure portal
   - Verify NSG rules allow traffic
   - Try different connection method

### Windows-Specific Issues

1. **Line Ending Problems**:
   ```bash
   git config --global core.autocrlf false
   ```

2. **PowerShell Terraform**:
   ```powershell
   # Use PowerShell Core or ensure proper execution policy
   Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
   ```

3. **SSH from Windows**:
   - Use Windows Terminal or WSL
   - Consider PuTTY for GUI SSH client

## 🔄 Infrastructure Updates

### Scaling Workers
To add more worker nodes:
```hcl
# In compute.tf, change worker count
resource "azurerm_network_interface" "worker" {
  count = 3  # Change from 2 to 3
  # ... rest of configuration
}
```

### VM Size Changes
```bash
# Update terraform.tfvars
vm_size = "Standard_B4ms"

# Apply changes
terraform plan
terraform apply
```

## 🧹 Cleanup

### Complete Cleanup
```bash
terraform destroy
```

### Selective Cleanup
```bash
# Remove specific resources
terraform destroy -target=azurerm_linux_virtual_machine.worker
```

## 🔗 Integration with Kubernetes Setup

After infrastructure deployment:

1. **Connect to jumpbox via Azure Bastion**
2. **Clone the repository on the jumpbox**:
   ```bash
   git clone <repository-url>
   cd kubernetes-the-hard-way-azure
   ```
3. **Follow the documentation** starting with `docs/01-prerequisites.md`
4. **Use the pre-configured SSH aliases**:
   ```bash
   ssh control-plane
   ssh worker-1
   ssh worker-2
   ```

## 📝 File Structure

```
terraform/
├── main.tf                 # Main infrastructure resources
├── variables.tf            # Input variables
├── outputs.tf              # Output values
├── security.tf             # Network security groups
├── compute.tf              # Virtual machines
├── ssh.tf                  # SSH key management
├── scripts/
│   ├── jumpbox-init.sh     # Jumpbox initialization
│   └── k8s-node-init.sh    # Kubernetes node setup
├── terraform.tfvars.example # Example configuration
└── README.md               # This file
```

## 🎯 Next Steps

Once infrastructure is deployed:
1. Access the jumpbox via Azure Bastion
2. Follow the main lab documentation in `../docs/`
3. Start with certificate authority setup
4. Proceed through the step-by-step Kubernetes installation

The infrastructure is now ready for your Kubernetes the Hard Way journey! 🚀